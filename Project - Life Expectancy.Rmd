---
title: "Untitled"
output: html_document
date: "2022-12-05"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Intro to data

https://www.kaggle.com/datasets/kumarajarshi/life-expectancy-who

From Kagge:   "The Global Health Observatory (GHO) data repository under World Health Organization (WHO) keeps track of the health status as well as many other related factors for all countries. The datasets are made available to public for the purpose of health data analysis. The dataset related to life expectancy, health factors for 193 countries has been collected from the same WHO data repository website and its corresponding economic data was collected from United Nation website. Among all categories of health-related factors only those critical factors were chosen which are more representative. It has been observed that in the past 15 years , there has been a huge development in health sector resulting in improvement of human mortality rates especially in the developing nations in comparison to the past 30 years. Therefore, in this project we have considered data from year 2000-2015 for 193 countries for further analysis. The individual data files have been merged together into a single dataset. On initial visual inspection of the data showed some missing values. As the datasets were from WHO, we found no evident errors. Missing data was handled in R software by using Missmap command. The result indicated that most of the missing data was for population, Hepatitis B and GDP. The missing data were from less known countries like Vanuatu, Tonga, Togo,Cabo Verde etc. Finding all data for these countries was difficult and hence, it was decided that we exclude these countries from the final model dataset. The final merged file(final dataset) consists of 22 Columns and 2938 rows which meant 20 predicting variables. All predicting variables was then divided into several broad categories: Immunization related factors, Mortality factors, Economical factors and Social factors."


# Libraries 

```{r, message=FALSE, warning=FALSE}
library(tidyverse)
library(skimr)
library(GGally)
library(ggpattern)
library(ggrepel)
library(gt)
library(gtExtras)
library(readr)
library(car)
library(broom)
```

# Data handline

## Read In Data Set

```{r, message=FALSE, warning=FALSE}
df <- read_csv("/Users/christinalopez/Desktop/STAT510_F22/datasets/Life.csv")
```

```{r}
glimpse(df)

skim_without_charts(df)
```

## Filter for a subset of data to analyze

```{r}
df1 <- df %>%
  filter(Year %in% "2014",
         Status %in% "Developing") %>%
  select(-Country, -Year, -Status) %>%
  drop_na()

skim_without_charts(df1)

head(df1)
```

# Variable Selection

## AIC variable selection

```{r}
n = nrow(df1)
mod0 = lm(`Life expectancy` ~ 1, data = df1)
mod.all = lm(`Life expectancy` ~., data = df1)
step(mod0, scope = list(lower = mod0, upper = mod.all))
```


```{r}
mod.full <- lm(`Life expectancy` ~ `Income composition of resources` + 
    `Adult Mortality` + `HIV/AIDS` + `Total expenditure`, data = df1)
summary(mod.full)
```

## Best subset regression variable selection


```{r}
xmat = df1 |>
select(-`Life expectancy`) |>
select_if(is.numeric)
head(xmat)
```

```{r}
dim(xmat)
```

```{r}
library(leaps)
mod = regsubsets(xmat, df1$`Life expectancy`, nvmax = 18)
summary.mod = summary(mod)
names(summary.mod)
```

```{r}
summary.mod$which

names(df)
```

```{r}
summary.mod$rsq #check R^2
```

```{r}
summary.mod$adjr2 #check adjusted R^2
```

```{r}
plot(summary.mod$adjr2)
```

```{r}
plot(summary.mod$cp) #check Mallows' Cp
abline(1,1)
```

```{r}
summary.mod$cp
```

```{r}
mod.cp = lm(`Life expectancy` ~., data = df1)
summary(mod.cp)
```

```{r}
anova(mod.full,mod.cp)
```

p-value >0.05, so we can accept the model from AIC variable selection.

## Check interactions on AIC model

```{r}
add1(mod.full, ~.+`Income composition of resources`*`Adult Mortality`+`Income composition of resources`*`HIV/AIDS`+`Income composition of resources`*`Total expenditure`, test = 'F')
```

## Update AIC model with interaction effect

```{r}
mod.2 = update(mod.full, ~.+`Income composition of resources`:`Total expenditure`+`Income composition of resources`:`HIV/AIDS`)
summary(mod.2)
```

## Regression Table For Full Model

```{r}
summary(mod.2)
```


# Check LINE conditions

## Variance and linearity

```{r}
library(broom)
model.table = augment(mod.2)
names(model.table)
ggplot(model.table, aes(x = .fitted, y = .resid)) +
  geom_point() +
  geom_hline(yintercept = 0, colour = 'blue') +
  labs(x = 'Fitted Values', y = 'Residuals') +
  ggtitle('Residual vs Fit') +
  theme_bw()
```

## Normality

```{r}
ggplot(model.table, aes(sample = .resid)) +
  stat_qq() +
  stat_qq_line() +
  ggtitle('Normal Q-Q Plot') +
  theme_bw()
```

```{r}
shapiro.test(resid(mod.2))
```


# Visualization

```{r}
df1 <- df %>%
  filter(Year %in% "2014",
         Status %in% "Developing") %>%
  drop_na()
```

## Top and bottom countries

```{r}

df1 %>%
  arrange(desc(`Life expectancy`)) %>%
  head(10) %>%
  ggplot(aes(x = reorder(Country,-`Life expectancy`), y = `Life expectancy`)) +
  geom_bar(stat = "identity", fill = "#FBEAEB", color = "black") +
  geom_text(aes(label=`Life expectancy`), vjust=0, color="black", size=3) +
  labs(x = "Countries",
       title = "Countries With The Highest Life Expectancy in 2014") +
  theme_bw()

```

```{r}
df1 %>%
  arrange(`Life expectancy`) %>%
  head(10) %>%
  ggplot(aes(x = reorder(Country,`Life expectancy`), y = `Life expectancy`)) +
  geom_bar(stat = "identity", fill = "#FBEAEB", color = "black") +
  geom_text(aes(label=`Life expectancy`), vjust=0, color="black", size=3) +
  labs(x = "Countries",
       title = "Countries With The Lowest Life Expectancy in 2014") +
  theme_bw()
```



## Income Composition of Resources

```{r}
df1 %>% 
  summarize(`Income composition of resources` = mean(`Income composition of resources`),
            LieExp = mean(`Life expectancy`))
```


```{r}
df1 %>%
  ggplot(aes(x = `Income composition of resources`, y = `Life expectancy`, label = Country)) +
geom_point(shape = 21, color = "white", fill = "#ADEFD1FF", size = 2) +
  geom_text_repel(color = "#ADEFD1FF") +
  geom_hline(yintercept = 68.74, color = "#9CC3D5FF", alpha = 0.6, linetype = "dashed") +
  geom_vline(xintercept = 0.64, color = "#9CC3D5FF", alpha = 0.6, linetype = "dashed") +
  annotate("text", family = "Helvetica", fontface = "bold",
           x = 0.235 , y = 70, hjust = 0, alpha = 0.3, color = "#ADEFD1FF",
           label = "Average Life Expetancy") +
  annotate("text", family = "Helvetica", fontface = "bold",
           x = 0.63, y = 60, alpha = 0.3, angle = 90, size = 4, color = "#ADEFD1FF",
           label = "Average Income composition of resources") +
  xlab("Income composition of resources") + ylab("Life Expetancy") +
  labs(title = "Life expectancy and Income composition of resources",
       subtitle = "Developing Countires in 2014") +
  scale_y_continuous(limits = c(40, 80)) +
  ggthemes::theme_solarized_2(light = FALSE, base_family = "Helvetica") +
  theme(panel.background = element_rect(color = "#89CFF0"),
        plot.title = element_text(size = 18, face = "bold", color = "white"),
        plot.subtitle = element_text(size = 12, color = "#00FFEF"),
        plot.caption = element_text(size = 14, color = "#89CFF0"),
        axis.title = element_text(size = 14, color = "white"),
        axis.text = element_text(size = 12, color = "#89CFF0"),
        panel.grid.minor.x = element_blank())
```


## Adult Mortality


```{r}
df1 %>% 
  summarize(`Adult Mortality` = mean(`Adult Mortality`),
            LieExp = mean(`Life expectancy`))
```

```{r}
df1 %>%
  ggplot(aes(x = `Adult Mortality`, y = `Life expectancy`, label = Country)) +
geom_point(shape = 21, color = "white", fill = "#ADEFD1FF", size = 2) +
  geom_text_repel(color = "#ADEFD1FF") +
  geom_hline(yintercept = 68.74, color = "#9CC3D5FF", alpha = 0.6, linetype = "dashed") +
  geom_vline(xintercept = 174.47, color = "#9CC3D5FF", alpha = 0.6, linetype = "dashed") +
  annotate("text", family = "Helvetica", fontface = "bold",
           x = 0.235 , y = 70, hjust = 0, alpha = 0.3, color = "#ADEFD1FF",
           label = "Average Life Expetancy") +
  annotate("text", family = "Helvetica", fontface = "bold",
           x = 168, y = 60, alpha = 0.3, angle = 90, size = 4, color = "#ADEFD1FF",
           label = "Average Adult Mortality") +
  xlab("Adult Mortality") + ylab("Life Expetancy") +
  labs(title = "Life expectancy and Adult Mortality",
       subtitle = "Developing Countires in 2014") +
  scale_y_continuous(limits = c(40, 80)) +
  ggthemes::theme_solarized_2(light = FALSE, base_family = "Helvetica") +
  theme(panel.background = element_rect(color = "#89CFF0"),
        plot.title = element_text(size = 18, face = "bold", color = "white"),
        plot.subtitle = element_text(size = 12, color = "#00FFEF"),
        plot.caption = element_text(size = 14, color = "#89CFF0"),
        axis.title = element_text(size = 14, color = "white"),
        axis.text = element_text(size = 12, color = "#89CFF0"),
        panel.grid.minor.x = element_blank())
```

## HIV/AIDS


```{r}
df1 %>% 
  summarize(`HIV/AIDS` = mean(`HIV/AIDS`),
            LieExp = mean(`Life expectancy`))
```


```{r}
df1 %>%
  ggplot(aes(x = `HIV/AIDS`, y = `Life expectancy`, label = Country)) +
geom_point(shape = 21, color = "white", fill = "#ADEFD1FF", size = 2) +
  geom_text_repel(color = "#ADEFD1FF") +
  geom_hline(yintercept = 68.74, color = "#9CC3D5FF", alpha = 0.6, linetype = "dashed") +
  geom_vline(xintercept = 0.93, color = "#9CC3D5FF", alpha = 0.6, linetype = "dashed") +
  annotate("text", family = "Helvetica", fontface = "bold",
           x = 0.235 , y = 70, hjust = 0, alpha = 0.3, color = "#ADEFD1FF",
           label = "Average Life Expetancy") +
  annotate("text", family = "Helvetica", fontface = "bold",
           x = 0.85, y = 60, alpha = 0.3, angle = 90, size = 4, color = "#ADEFD1FF",
           label = "Average HIV/AIDS") +
  xlab("HIV/AIDS") + ylab("Life Expetancy") +
  labs(title = "Life expectancy and HIV/AIDS",
       subtitle = "Developing Countires in 2014") +
  scale_y_continuous(limits = c(40, 80)) +
  ggthemes::theme_solarized_2(light = FALSE, base_family = "Helvetica") +
  theme(panel.background = element_rect(color = "#89CFF0"),
        plot.title = element_text(size = 18, face = "bold", color = "white"),
        plot.subtitle = element_text(size = 12, color = "#00FFEF"),
        plot.caption = element_text(size = 14, color = "#89CFF0"),
        axis.title = element_text(size = 14, color = "white"),
        axis.text = element_text(size = 12, color = "#89CFF0"),
        panel.grid.minor.x = element_blank())
```


## Total Expenditure

```{r}
df1 %>% 
  summarize(`Total expenditure` = mean(`Total expenditure`),
            LieExp = mean(`Life expectancy`))
```

```{r}
df1 %>%
  ggplot(aes(x = `Total expenditure`, y = `Life expectancy`, label = Country)) +
geom_point(shape = 21, color = "white", fill = "#ADEFD1FF", size = 2) +
  geom_text_repel(color = "#ADEFD1FF") +
  geom_hline(yintercept = 68.74, color = "#9CC3D5FF", alpha = 0.6, linetype = "dashed") +
  geom_vline(xintercept = 5.82, color = "#9CC3D5FF", alpha = 0.6, linetype = "dashed") +
  annotate("text", family = "Helvetica", fontface = "bold",
           x = 0.235 , y = 70, hjust = 0, alpha = 0.3, color = "#ADEFD1FF",
           label = "Average Life Expetancy") +
  annotate("text", family = "Helvetica", fontface = "bold",
           x = 5.6, y = 60, alpha = 0.3, angle = 90, size = 4, color = "#ADEFD1FF",
           label = "Average Total Expenditure") +
  xlab("Total Expenditure") + ylab("Life Expetancy") +
  labs(title = "Life expectancy and Life Expenditure",
       subtitle = "Developing Countires in 2014") +
  scale_y_continuous(limits = c(40, 80)) +
  ggthemes::theme_solarized_2(light = FALSE, base_family = "Helvetica") +
  theme(panel.background = element_rect(color = "#89CFF0"),
        plot.title = element_text(size = 18, face = "bold", color = "white"),
        plot.subtitle = element_text(size = 12, color = "#00FFEF"),
        plot.caption = element_text(size = 14, color = "#89CFF0"),
        axis.title = element_text(size = 14, color = "white"),
        axis.text = element_text(size = 12, color = "#89CFF0"),
        panel.grid.minor.x = element_blank())
```

## Summary Table


```{r}
df1 %>%
  select(Country, `Life expectancy`,`Adult Mortality`,`HIV/AIDS`,`Income composition of resources`,`Total expenditure`) %>%
  arrange(desc(`Life expectancy`)) %>%
  head(20) %>%
  gt(rowname_col = "Country") %>%
  tab_header(
    title = md("Summary of the **Life Expectancy** of Developing Countries in 2014")) %>%
  tab_source_note(
    source_note = md("The Global Health Observatory (GHO) data repository under World Health Organization (WHO) keeps track of the health status as well as many other related factors for all countries")
  ) %>%
  tab_stubhead(label = md("Countries")) %>%
  opt_table_font(font = google_font("Montserrat"), weight = 600) %>%
  data_color(
    columns = `Life expectancy`,
    fn = scales::col_numeric(
      palette = "viridis",
      domain = c(70, 95)
    )
  )


```


## Scatterplot matrix 

```{r, message=FALSE, warning=FALSE}

names(df1)
df2 <- df1 |> 
  mutate(expectancy = `Life expectancy`, mortality = `Adult Mortality`, expenditure = `Total expenditure`, hiv.aids = `HIV/AIDS`, composition = `Income composition of resources`) |>
  select(expectancy, mortality, expenditure, hiv.aids, composition)

ggpairs(df2)
```



# Prediction 

## point prediction interval

```{r}
new <- df2 |>
  summarize(mortality = mean(mortality),
            hiv.aids = mean(hiv.aids),
            composition = mean(composition),
            expenditure = mean(expenditure)) |>
  data.frame()

mod.3 <- lm(expectancy ~ composition + mortality + hiv.aids + expenditure + composition:expenditure + composition:hiv.aids, data = df2)


# summary(mod.2)

#new = data.frame(`Adult Mortality` = 174.47, `HIV/AIDS` = 0.930, `Income composition of resources` = 0.636, `Total expenditure` = 5.82)


pi = predict(mod.3, new, interval = "prediction", level = 0.95)
pi
```

